# yaml-language-server: $schema=https://raw.githubusercontent.com/compose-spec/compose-spec/master/schema/compose-spec.json
name: "gridfcm"

# https://repo.stratebi.com
x-shiny-server-image: &shiny-server-image "repo.stratebi.com/stratebi/shiny-server:v1.5.20.1002-14"
# https://hub.docker.com/_/postgres
x-postgres-image: &postgres-image "docker.io/postgres:15-bookworm"

services:

  shiny-server:
    image: *shiny-server-image
    restart: "on-failure:3"
    container_name: "gridfcm-shiny-server"
    hostname: "shiny-server"
    networks:
      - "gridfcm"
    ports:
      - "${SHINY_SERVER_HOST:-127.0.0.1}:${SHINY_SERVER_PORT:-3838}:3838/tcp"
    volumes:
      - "./DB/:/srv/shiny-server/DB/:ro"
      - "./R/:/srv/shiny-server/R/:ro"
      - "./Servers/:/srv/shiny-server/Servers/:ro"
      - "./Traductions/:/srv/shiny-server/Traductions/:ro"
      - "./UI/:/srv/shiny-server/UI/:ro"
      - "./ficheros/:/srv/shiny-server/ficheros/:ro"
      - "./www/:/srv/shiny-server/www/:ro"
      - "./DESCRIPTION:/srv/shiny-server/DESCRIPTION:ro"
      - "./app.R:/srv/shiny-server/app.R:ro"
      - "./global.R:/srv/shiny-server/global.R:ro"
      - "r-data:/data/"
    environment:
      SHINY_DEPLOY_SAMPLE_APPS: "${SHINY_DEPLOY_SAMPLE_APPS:-true}"
      DB_HOST: "${DB_HOST:-postgres}"
      DB_PORT: "${DB_PORT:-5432}"
      DB_NAME: "${DB_NAME:-gridfcm}"
      DB_USER: "${DB_USER:-gridfcm}"
      DB_PASSWORD: "${DB_PASSWORD:?}"
    depends_on:
      postgres:
        condition: "service_healthy"

  postgres:
    image: *postgres-image
    restart: "on-failure:3"
    container_name: "gridfcm-postgres"
    hostname: "postgres"
    networks:
      - "gridfcm"
    ports:
      - "${POSTGRES_HOST-127.0.0.1}:${POSTGRES_PORT-5433}:5432/tcp"
    volumes:
      - "./DB/db.sql:/docker-entrypoint-initdb.d/db.sql:ro"
      - "postgres-data:/var/lib/postgresql/data/"
    environment:
      POSTGRES_DB: "${DB_NAME:-gridfcm}"
      POSTGRES_USER: "${DB_USER:-gridfcm}"
      POSTGRES_PASSWORD: "${DB_PASSWORD:-password}"
    healthcheck:
      test: ["CMD-SHELL", 'pg_isready -q -d "$${POSTGRES_DB:?}" -U "$${POSTGRES_USER:?}"']
      start_period: "5m"
      interval: "10s"
      timeout: "5s"
      retries: 2

volumes:

  r-data:
    name: "gridfcm-r-data"

  postgres-data:
    name: "gridfcm-postgres-data"

networks:

  gridfcm:
    name: "gridfcm"
    driver: "bridge"
    internal: false
